<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda tu env√≠o</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <style>

    form input,
form select {
  width: 100%;
  box-sizing: border-box;
  border-radius: 8px;
}

    
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input { width: 100%; padding: 8px; margin-top: 5px; }
    .select2-container .select2-selection--single { height: 38px; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { white-space: pre-line; }
.contenedor-boton {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

button[type="submit"] {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}

    .select2-container { width: 100% !important; }
    
  </style>
</head>
<body>

  <h2>Agenda tu env√≠o (@complicidadboutique)</h2>

  <form id="formulario">
    

    
    
    
      <label>WhatsApp con el que compraste</label>
      <input type="text" id="telefonoUsado" name="telefonoUsado" required placeholder="Ingresa tu n√∫mero">

    
    <label>Selecciona el tipo de servicio</label>
    <select id="tipoAccion" name="tipoAccion" required>
      <option value="" disabled selected>Elige una opci√≥n</option>
      <option value="shalom">Retiro en agencia Shalom</option>
      <option value="delivery">Env√≠o a domicilio/trabajo (Delivery)</option>
      <option value="recoger">Recoger en almac√©n</option>
      <option value="usado">Usar mi direcci√≥n registrada</option>
    </select>
    
    <div id="camposDelivery" style="display: none;">
      
      <h2>üì¶ Delivery</h2>
      <legend>Datos de la persona que recibir√° el pedido en su domicilio o trabajo</legend>
      
      <label>Nombre:</label>
      <input type="text" name="nombre" required>

      <label>Tel√©fono:</label>
      <input type="text" name="telefono" required>
      
      <label for="distrito">Distrito:</label>
      <input list="lstDistritos" id="distrito" name="distrito" autocomplete="off" required />
      <datalist id="lstDistritos"></datalist>
      <div class="error" id="error"></div>
      
      <label>Direcci√≥n:</label>
      <input type="text" name="direccion" required>

      <label>Referencia:</label>
      <input type="text" name="referencia" required>
      
    </div>

    <div id="camposShalom" style="display: none;">
      
      <h2>üì¶ Shalom</h2>
      <legend>Datos de la persona que recoger√° el pedido en la agencia Shalom</legend>
      
      <label>Nombre completo:</label>
      <input type="text" name="nombre" required>

      <label>Tel√©fono:</label>
      <input type="text" name="telefono" required>
      
      <label>DNI/CE:</label>
      <input type="text" name="DNI" required>

      <label>Agencia:</label>
      <select id="agencia" name="agencia" class="select2" required></select>

    </div>

    <div id="camposUsados" style="display: none;">
      
      <h2>üòç Ya eres parte de la familia</h2>
      <legend>Solo elige tu fecha de env√≠o:</legend>
      
    </div>
    

    <!-- Campo de fecha reutilizable -->
    <div id="contenedorFecha" style="display: none;">
      <label for="fecha">Fecha de env√≠o:</label>
      <select id="fecha" name="fecha"required></select>
    </div>


    <div class="contenedor-boton">
      <button type="submit">Enviar</button>
    </div>

  </form>


<footer style="padding:20px; text-align:center; font-family:sans-serif;">

  <div style="margin-top:10px;">
    <a href="https://www.tiktok.com/@complicidadboutique" target="_blank" style="margin-right:15px; text-decoration:none;">
      <img src="https://cdn-icons-png.flaticon.com/512/3046/3046122.png" alt="TikTok" width="24" style="vertical-align:middle;">
      <span style="margin-left:5px; font-size:14px;"></span>
    </a>

    <a href="https://wa.me/51981391159" target="_blank" style="text-decoration:none;">
      <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="WhatsApp" width="24" style="vertical-align:middle;">
      <span style="margin-left:5px; font-size:14px;"></span>
    </a>
  </div>

  <p style="margin-top:15px; font-size:12px; color:#888;">¬© 2025 Complicidad. Todos los derechos reservados.</p>
</footer>


  <script>
       
    const urlShalom = "https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json";
    const scriptURL = "https://script.google.com/macros/s/AKfycbwywJN-AoE39NHrAwAYR0GFfrs94ys-1eIyEvn0SNLPPhUMBCK9hBWbYfP1CrZ6o20npQ/exec";
    const urlDistritos = "https://raw.githubusercontent.com/complicidad/form/main/lstDistritos.json";
    const datalist = document.getElementById('lstDistritos');
    const input = document.getElementById('distrito');
    const form = document.getElementById('formulario');
    const error = document.getElementById('error');
    let distritos = [];
    let telefonosRegistrados = [];



  
$(document).ready(function () {
  
  
        // Cargar distritos desde la URL
    fetch(urlDistritos)
      .then(response => response.json())
      .then(data => {
        distritos = data.map(d => d.Distrito.toLowerCase());
        data.forEach(d => {
          const option = document.createElement('option');
          option.value = d.Distrito;
          datalist.appendChild(option);
        });
      })
      .catch(err => {
        console.error("Error al cargar distritos:", err);
        error.textContent = "No se pudo cargar la lista de distritos.";
      });  
  
  
function obtenerFechasEnvio() {
  const ahora = new Date();
  const opciones = [];
  const diasPermitidos = [3, 5]; // martes (2), viernes (5)
  const horaCorte = 10; // 10:00 a.m.
  const limite = new Date();
  limite.setDate(ahora.getDate() + 14); // hasta 2 semanas

  let fecha = new Date();
  fecha.setHours(0, 0, 0, 0); // normaliza hora

  while (fecha <= limite) {
    const diaSemana = fecha.getDay();

    if (diasPermitidos.includes(diaSemana)) {
      const fechaCorte = new Date(fecha);
      fechaCorte.setDate(fecha.getDate() - 1); // d√≠a anterior
      fechaCorte.setHours(horaCorte, 0, 0, 0); // 10:00 a.m. del d√≠a anterior

      if (ahora < fechaCorte) {
        opciones.push(new Date(fecha));
      }
    }

    fecha.setDate(fecha.getDate() + 1);
  }

  return opciones;
}


function formatearFecha(fecha) {
    return fecha.toLocaleDateString('es-ES', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
}

const select = document.getElementById('fecha');
const fechas = obtenerFechasEnvio();
fechas.forEach(f => {
    const option = document.createElement('option');
    option.value = f.toISOString().split('T')[0]; // formato yyyy-mm-dd
    option.textContent = formatearFecha(f);
    select.appendChild(option);
});
  

    $('#agencia').select2({
        placeholder: 'Selecciona una agencia',
        allowClear: true,
        templateResult: function (data) {
            if (!data.id) return data.text;
            const lineas = data.text.split('\n');
            return $('<span>').html(`<strong>${lineas[0]}</strong><br>${lineas.slice(1).join('<br>')}`);
        },
        templateSelection: function (data) {
            return data.text.split('\n')[0];
        }
    });



    // Cargar Agencias desde JSON en GitHub
    const cargarAgencias = $.getJSON(urlShalom)
        .done(data => {
            let opciones = '<option></option>';
            data.forEach(d => {
                opciones += `<option value="${d.Shalom}">${d.Shalom}</option>`;
            });
            $('#agencia').html(opciones).trigger('change');
        });

    // Cargar Tel√©fonos desde Google Sheets (se mantiene igual)
const cargarTelefonos = $.getJSON(`${scriptURL}?sheet=Clientes`)
    .done(data => {
telefonosRegistrados = data.values
  .map(row => String(row[0]).replace(/\D/g, '')) // üëà convierte a string primero
  .filter(t => t.length === 9);


    });


    Promise.all([cargarAgencias, cargarTelefonos])
        .catch(() => alert("Error al cargar datos"));
  
      function limpiarCampos(idContenedor) {
          document.querySelectorAll(`#${idContenedor} input, #${idContenedor} select`).forEach(campo => {
              if (campo.tagName === 'SELECT') {
                  // Siempre limpia la selecci√≥n
                  $(campo).val(null).trigger('change');
              } else {
                  campo.value = '';
              }
          });
      }

      
      // Mostrar/ocultar campos seg√∫n acci√≥n
      $('#tipoAccion').on('change', function () {




        // Limpia los tres bloques
        limpiarCampos('camposDelivery');
        limpiarCampos('camposShalom');
        limpiarCampos('camposUsados');
        
        // 1) Ocultar y deshabilitar todo
        $('#camposDelivery, #camposShalom, #camposUsados')
          .hide()
          .find('input, select')
          .prop('disabled', true);



      
        // 2) Mostrar y habilitar el bloque correspondiente
        const v = $(this).val();
        if (v === 'delivery') {
          $('#camposDelivery').show().find('input, select').prop('disabled', false);
        }
        else if (v === 'shalom') {
          $('#camposShalom').show().find('input, select').prop('disabled', false);
        }
        else if (v === 'usado') {
          $('#camposUsados').show().find('input, select').prop('disabled', false);
        };
      

        // Mover el campo de fecha al bloque correspondiente
        const contenedorFecha = $('#contenedorFecha');
        contenedorFecha.hide(); // Oculta antes de mover
        
        if (v === 'delivery') {
          $('#camposDelivery').append(contenedorFecha);
          contenedorFecha.show();
          $('#fecha').prop('disabled', false);
        }
        else if (v === 'shalom') {
          $('#camposShalom').append(contenedorFecha);
          contenedorFecha.show();
          $('#fecha').prop('disabled', false);
        }
        else if (v === 'usado') {
          $('#camposUsados').append(contenedorFecha);
          contenedorFecha.show();
          $('#fecha').prop('disabled', false);
        }
});

      // Env√≠o del formulario
$('#formulario').on('submit', function (e) {
  e.preventDefault();
  const tipoAccion = $('#tipoAccion').val();
  const formData = new FormData(this);

  // Validaci√≥n solo si se seleccion√≥ "Usar mi direcci√≥n registrada"
  if (tipoAccion === 'usado') {
const telefonoIngresado = $('#telefonoUsado').val().replace(/\D/g, '');


    if (!telefonoIngresado) {
      alert('Por favor, ingresa tu n√∫mero registrado.');
      return;
    }

    if (!telefonosRegistrados.includes(telefonoIngresado)) {
      alert('El n√∫mero ingresado no est√° registrado. Verifica e intenta nuevamente.');
      return;
    }
  }

  // Si pasa la validaci√≥n, se env√≠a el formulario
  $.ajax({
    url: scriptURL,
    method: "POST",
    data: formData,
    processData: false,
    contentType: false,
    success: function () {
      alert("Datos enviados correctamente");
      $('#formulario')[0].reset();
      $('.select2').val(null).trigger('change');
      $('#camposDelivery, #camposShalom, #camposUsados')
        .hide()
        .find('input, select')
        .prop('disabled', true);
    },
    error: function () {
      alert("Ocurri√≥ un error al enviar tus datos");
    }
  });
});

    });
  </script>

</body>
</html>
