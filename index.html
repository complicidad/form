<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda tu env√≠o</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <style>

    form input,
form select {
  width: 100%;
  box-sizing: border-box;
  border-radius: 8px;
}

    
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input { width: 100%; padding: 8px; margin-top: 5px; }
    .select2-container .select2-selection--single { height: 38px; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { white-space: pre-line; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .select2-container { width: 100% !important; }
    
  </style>
</head>
<body>

  <h2>Agenda tu env√≠o</h2>

  <form id="formulario">
    <label>Selecciona el tipo de servicio</label>
    <select id="tipoAccion" name="tipoAccion" required>
      <option value="" disabled selected>Elige una opci√≥n</option>
      <option value="delivery">üìù Env√≠o a domicilio/trabajo (Delivery)</option>
      <option value="shalom">üìù Retiro en agencia Shalom</option>
      <option value="usado">üì≤ Usar mi direcci√≥n registrada</option>
    </select>
    
    <div id="camposDelivery" style="display: none;">
      <label>Nombre completo:</label>
      <input type="text" name="nombre" required>

      <label>Tel√©fono:</label>
      <input type="text" name="telefono" required>
      
      <label>Distrito:</label>
      <select id="distrito" name="distrito" required></select>
      
      <label>Direcci√≥n:</label>
      <input type="text" name="direccion" required>

      <label>Referencia:</label>
      <input type="text" name="referencia" required>
      
<label for="fecha">Fecha de env√≠o:</label>
<select id="fecha" name="fecha"></select>
    </div>

    <div id="camposShalom" style="display: none;">
      <label>Nombre completo:</label>
      <input type="text" name="nombre" required>

      <label>Tel√©fono:</label>
      <input type="text" name="telefono" required>
      
      <label>DNI:</label>
      <input type="text" name="DNI" required>

      <label>Agencia:</label>
      <select id="agencia" name="agencia" class="select2" required></select>

<label for="fecha">Fecha de env√≠o:</label>
<select id="fecha" name="fecha"></select>
    </div>

    <div id="camposUsados" style="display: none;">
      <label>Tel√©fono:</label>
<input type="text" id="telefonoUsado" name="telefonoUsado" required placeholder="Ingresa tu n√∫mero registrado">



<label for="fecha">Fecha de env√≠o:</label>
<select id="fecha" name="fecha"></select>
    </div>

    <button type="submit">Enviar</button>
  </form>

  <script>
    
    let telefonosRegistrados = [];

    
const urlDistritos = "https://raw.githubusercontent.com/complicidad/form/main/lstDistritos.json";
const urlShalom = "https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json";
const scriptURL = "https://script.google.com/macros/s/AKfycbwywJN-AoE39NHrAwAYR0GFfrs94ys-1eIyEvn0SNLPPhUMBCK9hBWbYfP1CrZ6o20npQ/exec";

    function obtenerFechasEnvio() {
    const hoy = new Date();
    const opciones = [];
    const diasPermitidos = [2, 5]; // 2 = martes, 5 = viernes
    const limite = new Date(hoy);
    limite.setDate(hoy.getDate() + 14); // +2 semanas

    let fecha = new Date(hoy);
    while (fecha <= limite) {
        if (diasPermitidos.includes(fecha.getDay())) {
            opciones.push(new Date(fecha));
        }
        fecha.setDate(fecha.getDate() + 1);
    }
    return opciones;
}

function formatearFecha(fecha) {
    return fecha.toLocaleDateString('es-ES', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
}

const select = document.getElementById('fecha');
const fechas = obtenerFechasEnvio();
fechas.forEach(f => {
    const option = document.createElement('option');
    option.value = f.toISOString().split('T')[0]; // formato yyyy-mm-dd
    option.textContent = formatearFecha(f);
    select.appendChild(option);
});
    
    
$(document).ready(function () {
    // Inicializar Select2
    $('#distrito').select2({
        placeholder: 'Escribe el distrito...',
        minimumInputLength: 1, // solo muestra cuando escribe al menos 1 letra
        dropdownAutoWidth: true,
        width: '100%',
        language: {
            inputTooShort: function () {
                return 'Escribe al menos una letra';
            }
        }
    });
    $('#agencia').select2({
        placeholder: 'Selecciona una agencia',
        allowClear: true,
        templateResult: function (data) {
            if (!data.id) return data.text;
            const lineas = data.text.split('\n');
            return $('<span>').html(`<strong>${lineas[0]}</strong><br>${lineas.slice(1).join('<br>')}`);
        },
        templateSelection: function (data) {
            return data.text.split('\n')[0];
        }
    });

    // Cargar Distritos desde JSON en GitHub
    const cargarDistritos = $.getJSON(urlDistritos)
        .done(data => {
            let opciones = '<option></option>';
            data.forEach(d => {
                opciones += `<option value="${d.Distrito}">${d.Distrito}</option>`;
            });
            $('#distrito').html(opciones).trigger('change');
        });

    // Cargar Agencias desde JSON en GitHub
    const cargarAgencias = $.getJSON(urlShalom)
        .done(data => {
            let opciones = '<option></option>';
            data.forEach(d => {
                opciones += `<option value="${d.Shalom}">${d.Shalom}</option>`;
            });
            $('#agencia').html(opciones).trigger('change');
        });

    // Cargar Tel√©fonos desde Google Sheets (se mantiene igual)
const cargarTelefonos = $.getJSON(`${scriptURL}?sheet=Clientes`)
    .done(data => {
telefonosRegistrados = data.values
  .map(row => String(row[0]).replace(/\D/g, '')) // üëà convierte a string primero
  .filter(t => t.length === 9);


    });


    Promise.all([cargarDistritos, cargarAgencias, cargarTelefonos])
        .catch(() => alert("Error al cargar datos"));
  
      function limpiarCampos(idContenedor) {
          document.querySelectorAll(`#${idContenedor} input, #${idContenedor} select`).forEach(campo => {
              if (campo.tagName === 'SELECT') {
                  // Siempre limpia la selecci√≥n
                  $(campo).val(null).trigger('change');
              } else {
                  campo.value = '';
              }
          });
      }

      
      // Mostrar/ocultar campos seg√∫n acci√≥n
      $('#tipoAccion').on('change', function () {

        // Limpia los tres bloques
        limpiarCampos('camposDelivery');
        limpiarCampos('camposShalom');
        limpiarCampos('camposUsados');
        
        // 1) Ocultar y deshabilitar todo
        $('#camposDelivery, #camposShalom, #camposUsados')
          .hide()
          .find('input, select')
          .prop('disabled', true);
      
        // 2) Mostrar y habilitar el bloque correspondiente
        const v = $(this).val();
        if (v === 'delivery') {
          $('#camposDelivery').show().find('input, select').prop('disabled', false);
        }
        else if (v === 'shalom') {
          $('#camposShalom').show().find('input, select').prop('disabled', false);
        }
        else if (v === 'usado') {
          $('#camposUsados').show().find('input, select').prop('disabled', false);
        }
      });

      // Env√≠o del formulario
$('#formulario').on('submit', function (e) {
  e.preventDefault();
  const tipoAccion = $('#tipoAccion').val();
  const formData = new FormData(this);

  // Validaci√≥n solo si se seleccion√≥ "Usar mi direcci√≥n registrada"
  if (tipoAccion === 'usado') {
const telefonoIngresado = $('#telefonoUsado').val().replace(/\D/g, '');


    if (!telefonoIngresado) {
      alert('Por favor, ingresa tu n√∫mero registrado.');
      return;
    }

    if (!telefonosRegistrados.includes(telefonoIngresado)) {
      alert('El n√∫mero ingresado no est√° registrado. Verifica e intenta nuevamente.');
      return;
    }
  }

  // Si pasa la validaci√≥n, se env√≠a el formulario
  $.ajax({
    url: scriptURL,
    method: "POST",
    data: formData,
    processData: false,
    contentType: false,
    success: function () {
      alert("Datos enviados correctamente");
      $('#formulario')[0].reset();
      $('.select2').val(null).trigger('change');
      $('#camposDelivery, #camposShalom, #camposUsados')
        .hide()
        .find('input, select')
        .prop('disabled', true);
    },
    error: function () {
      alert("Ocurri√≥ un error al enviar tus datos");
    }
  });
});

    });
  </script>

</body>
</html>
