<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agenda tu env√≠o</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        /* =========================================
           Tokens y base
        ========================================== */
        :root {
            --brand: #1a73e8;
            --brand-hover: #1669c1;
            --text: #222;
            --muted: #555;
            --bg-muted: #f4f4f4;
            --border: #e5e5e5;
            --danger: #d93025;
            --radius: 8px;
            --space-1: 5px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 15px;
            --space-5: 20px;
        }

        /* Layout container principal */
        .container {
            padding: var(--space-5);
            max-width: 640px;
            margin: 0 auto;
            font-family: Arial, sans-serif;
            color: var(--text);
        }

        /* Secciones de formulario */
        .section {
            margin-top: var(--space-4);
        }

        .section-help {
            margin: var(--space-2) 0;
            color: var(--muted);
            font-size: 13px;
        }

        /* Accesibilidad: oculto visualmente pero accesible */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        /* Etiquetas y controles */
        label {
            display: block;
            margin-top: var(--space-4);
            font-weight: bold;
        }

        input,
        select,
        button {
            font: inherit;
        }

        input,
        select {
            width: 100%;
            padding: var(--space-2);
            margin-top: var(--space-1);
            box-sizing: border-box;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: #fff;
            outline: none;
            transition: box-shadow .15s ease, border-color .15s ease;
        }

        input:focus,
        select:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        /* Estado de error b√°sico para validaci√≥n */
        .is-invalid {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 3px rgba(217, 48, 37, .15) !important;
        }

        /* Texto de privacidad */
        .texto-privacidad {
            margin-top: var(--space-5);
            font-size: 13px;
            color: var(--muted);
            text-align: left;
        }

        .texto-privacidad a {
            color: var(--brand);
            text-decoration: none;
        }

        /* Botones */
        .contenedor-boton {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: var(--space-4);
        }

        button[type="submit"] {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: var(--brand);
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            width: 100%;
            transition: background-color .15s ease;
        }

        button[type="submit"]:hover {
            background-color: var(--brand-hover);
        }


        /* =========================================
           Spinner de carga
        ========================================== */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #spinner img {
            width: 100px;
            height: auto;
            animation: spin 1s linear infinite;
        }

        /* Estilo del overlay del popup */
        .modal {
            display: none;
            /* Oculto por defecto */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            justify-content: center;
            align-items: center;
            align-items: flex-start;
            /* Alinea arriba en vez de al centro */
            padding-top: 20px;
            /* Espacio desde arriba */
            padding-bottom: 20px;
            /* Espacio desde arriba */
        }

        /* Caja del popup */
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 350px;
            max-height: 95vh;
            /* Antes 80vh, ahora m√°s alto */
            overflow-y: auto;
        }

        .list {
            max-height: 80vh;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .list-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .list-item:hover {
            background: #f0f0f0;
        }

        /* Compatibilidad con IDs existentes */
        #listaDistritos,
        #listaAgencias {
            max-height: 80vh;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #listaDistritos li,
        #listaAgencias li {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        #listaDistritos li:hover,
        #listaAgencias li:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>

    <div style="text-align:center; margin-bottom: 0px;">
        <img src="https://raw.githubusercontent.com/complicidad/form/main/Logo.png" alt="Logo Complicidad"
            style="max-width: 200px; height: auto;">
    </div>

    <main class="container">
        <h2 style="margin: 5px 0px 5px; ">Agenda tu env√≠o</h2>
        <form id="formulario" novalidate>
            <label for="telefonoUsado">WhatsApp con el que compraste</label>
            <input type="text" id="telefonoUsado" name="telefonoUsado" required placeholder="Ingresa tu n√∫mero"
                pattern="\d{9}" title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos" />

            <label for="tipoAccion">Selecciona el tipo de servicio</label>
            <select id="tipoAccion" name="tipoAccion" required>
                <option value="" disabled selected>Elige una opci√≥n</option>
                <option value="delivery">Env√≠o a domicilio/trabajo (Delivery)</option>
                <option value="shalom">Retiro en agencia Shalom</option>
                <option value="recoger">Recoger en almac√©n</option>
                <option value="usado">Usar mi direcci√≥n registrada</option>
            </select>

            <fieldset id="camposDelivery" class="section section--delivery" hidden>
                <legend>üì¶ Delivery</legend>
                <p class="section-help">Datos de la persona que recibir√° el pedido.</p>

                <label for="nombreDelivery">Nombre:</label>
                <input type="text" id="nombreDelivery" name="nombre" required />

                <label for="telefonoDelivery">Tel√©fono:</label>
                <input type="text" id="telefonoDelivery" name="telefono" required pattern="\d{9}"
                    title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos" />

                <label for="distrito">Distrito:</label>
                <input type="text" id="distrito" name="distrito" required />

                <label for="direccion">Direcci√≥n:</label>
                <input type="text" id="direccion" name="direccion" required />

                <label for="referencia">Referencia:</label>
                <input type="text" id="referencia" name="referencia" required />

                <div class="modal" id="modalDistrito">
                    <div class="modal-content">
                        <input type="text" id="buscadorDistrito" placeholder="Buscar distrito...">
                        <div id="listaDistritos"></div>
                    </div>
                </div>
            </fieldset>

            <fieldset id="camposShalom" class="section section--shalom" hidden>
                <legend>üì¶ Shalom</legend>
                <p class="section-help">Datos para retiro en agencia Shalom.</p>

                <label for="nombreShalom">Nombre completo:</label>
                <input type="text" id="nombreShalom" name="nombre" required />

                <label for="telefonoShalom">Tel√©fono:</label>
                <input type="text" id="telefonoShalom" name="telefono" required pattern="\d{9}"
                    title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos" />

                <label for="DNI">DNI/CE:</label>
                <input type="text" id="DNI" name="DNI" required />

                <label for="agencia">Agencia:</label>
                <input type="text" id="agencia" name="agencia" required />

                <div class="modal" id="modalAgencia">
                    <div class="modal-content">
                        <input type="text" id="buscadorAgencia" placeholder="Buscar agencia...">
                        <div id="listaAgencias"></div>
                    </div>
                </div>
            </fieldset>

            <fieldset id="camposUsados" class="section section--usado" hidden>
                <legend>üì¶ Direcci√≥n registrada</legend>
                <p class="section-help">Usaremos tu direcci√≥n guardada.</p>
            </fieldset>

            <div id="contenedorFecha" style="display: none;">
                <label for="fecha">Fecha de env√≠o:</label>
                <select id="fecha" name="fecha" required></select>
            </div>

            <div class="texto-privacidad">
                Usaremos tus datos solo para procesar y entregar tu pedido.<br>
                <a href="https://complicidad.github.io/privacy/" target="_blank">Ver pol√≠tica de privacidad</a>
            </div>

            <div class="contenedor-boton">
                <button type="submit">Confirmar y agendar env√≠o</button>
            </div>
        </form>
    </main>

    <footer style="
        background-color:#f4f4f4;
        padding:1px 1px;
        text-align: center;
        font-family: sans-serif;
        margin-top: 30px;
    ">
        <div style="margin: 10px 0; display: flex; justify-content: center; gap: 16px;">
            <a href="https://wa.me/51981391159" target="_blank" rel="noopener noreferrer"
                style="display: inline-flex; align-items: center;">
                <img src="https://raw.githubusercontent.com/complicidad/form/main/whatsapp.png" alt="WhatsApp" width="28"
                    height="28">
            </a>

            <a href="https://www.tiktok.com/@complicidadboutique" target="_blank" rel="noopener noreferrer"
                style="display: inline-flex; align-items: center;">
                <img src="https://raw.githubusercontent.com/complicidad/form/main/tik-tok.png" alt="TikTok" width="28"
                    height="28">
            </a>

            <a href="https://www.instagram.com/complicidadboutique" target="_blank" rel="noopener noreferrer"
                style="display: inline-flex; align-items: center;">
                <img src="https://raw.githubusercontent.com/complicidad/form/main/instagram.png" alt="Instagram" width="28"
                    height="28">
            </a>
        </div>

        <p style="margin-top: 15px; font-size: 12px; color: #888;">
            ¬© 2025 Complicidad. Todos los derechos reservados.
        </p>
    </footer>

    <div id="spinner" style="
        display:none;
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(255,255,255,0.85);
        z-index:9999;
        justify-content:center;
        align-items:center;
        flex-direction:column;
    ">
        <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Cargando..."
            style="width:150px; height:auto; animation:spin 2s linear infinite;">
        <p style="margin-top:15px; font-size:18px; color:#333;"></p>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzSqYVbDXoRSCvuUl-l-jAtiLauLj-h5KT99WJFxZQ4IBu1M_ErSj3foXqlrEoS3INuCA/exec";

        let telefonosRegistrados = [];

        // Funciones para manejo de listas de distritos y agencias
        const campoDistrito = document.getElementById("distrito");
        const overlay = document.getElementById("modalDistrito");
        const buscador = document.getElementById("buscadorDistrito");
        const listaDistritos = document.getElementById("listaDistritos");
        let distritos = [];

        campoDistrito.addEventListener("click", () => {
            overlay.style.display = "flex";
            buscador.value = "";
            mostrarDistritos(distritos);
            buscador.focus();
        });

        overlay.addEventListener("click", (e) => {
            if (e.target === overlay) {
                overlay.style.display = "none";
            }
        });

        buscador.addEventListener("input", () => {
            const filtro = buscador.value.toLowerCase();
            const filtrados = distritos.filter(d => d.toLowerCase().includes(filtro));
            mostrarDistritos(filtrados);
        });

        function mostrarDistritos(lista) {
            listaDistritos.innerHTML = "";
            lista.forEach(d => {
                const div = document.createElement("div");
                div.className = "list-item";
                div.textContent = d;
                div.addEventListener("click", () => {
                    campoDistrito.value = d;
                    overlay.style.display = "none";
                });
                listaDistritos.appendChild(div);
            });
        }

        const campoAgencia = document.getElementById("agencia");
        const overlayAgencia = document.getElementById("modalAgencia");
        const buscadorAgencia = document.getElementById("buscadorAgencia");
        const listaAgencias = document.getElementById("listaAgencias");
        let agencias = [];

        campoAgencia.addEventListener("click", () => {
            overlayAgencia.style.display = "flex";
            buscadorAgencia.value = "";
            mostrarAgencias(agencias);
            buscadorAgencia.focus();
        });

        overlayAgencia.addEventListener("click", (e) => {
            if (e.target === overlayAgencia) {
                overlayAgencia.style.display = "none";
            }
        });

        buscadorAgencia.addEventListener("input", () => {
            const filtro = buscadorAgencia.value.toLowerCase();
            const filtrados = agencias.filter(a => a.toLowerCase().includes(filtro));
            mostrarAgencias(filtrados);
        });

        function mostrarAgencias(lista) {
            listaAgencias.innerHTML = "";
            lista.forEach(a => {
                const [titulo, ...resto] = a.split("\n");
                const div = document.createElement("div");
                div.className = "list-item";
                div.innerHTML = `<strong>${titulo}</strong>${resto.length ? "<br>" + resto.join("<br>") : ""}`;
                div.addEventListener("click", () => {
                    campoAgencia.value = titulo;
                    overlayAgencia.style.display = "none";
                });
                listaAgencias.appendChild(div);
            });
        }

        // Funciones para l√≥gica principal
        function obtenerFechasEnvio() {
            const ahora = new Date();
            const opciones = [];
            const diasPermitidos = [2, 5]; // martes = 2, viernes = 5
            const horaCorte = 10; // 10:00 a.m.
            const limite = new Date();
            limite.setDate(ahora.getDate() + 14);

            let fecha = new Date();
            fecha.setHours(0, 0, 0, 0);

            while (fecha <= limite) {
                const diaSemana = fecha.getDay();
                if (diasPermitidos.includes(diaSemana)) {
                    const fechaCorte = new Date(fecha);
                    fechaCorte.setDate(fecha.getDate() - 1);
                    fechaCorte.setHours(horaCorte, 0, 0, 0);
                    if (ahora < fechaCorte) {
                        opciones.push(new Date(fecha));
                    }
                }
                fecha.setDate(fecha.getDate() + 1);
            }
            return opciones;
        }

        function formatearFecha(fecha) {
            return fecha.toLocaleDateString("es-ES", {
                weekday: "long",
                day: "2-digit",
                month: "long",
                year: "numeric",
            });
        }

        function limpiarCampos(idContenedor) {
            const selector = `#${idContenedor} input, #${idContenedor} select`;
            document.querySelectorAll(selector).forEach((campo) => {
                if (campo.tagName === "SELECT") {
                    $(campo).val(null).trigger("change");
                } else {
                    campo.value = "";
                }
            });
        }

        function manejarCambioServicio() {
            limpiarCampos("camposDelivery");
            limpiarCampos("camposShalom");
            limpiarCampos("camposUsados");

            $("#camposDelivery, #camposShalom, #camposUsados")
                .hide()
                .find("input, select")
                .prop("disabled", true);

            const valor = $(this).val();
            const $contenedorFecha = $("#contenedorFecha");
            $contenedorFecha.hide();

            if (valor === "delivery") {
                $("#camposDelivery").show().find("input, select").prop("disabled", false);
                $("#camposDelivery").append($contenedorFecha);
                $contenedorFecha.show();
                $("#fecha").prop("disabled", false);
            } else if (valor === "shalom") {
                $("#camposShalom").show().find("input, select").prop("disabled", false);
                $("#camposShalom").append($contenedorFecha);
                $contenedorFecha.show();
                $("#fecha").prop("disabled", false);
            } else if (valor === "usado") {
                $("#camposUsados").show().find("input, select").prop("disabled", false);
                $("#camposUsados").append($contenedorFecha);
                $contenedorFecha.show();
                $("#fecha").prop("disabled", false);
            } else {
                $("#fecha").prop("disabled", true);
            }
        }

        async function manejarEnvioFormulario(e) {
            e.preventDefault();

            const tipoAccion = $("#tipoAccion").val();
            if (tipoAccion === "usado") {
                const telefonoIngresado = $("#telefonoUsado").val().replace(/\D/g, "");
                if (!telefonoIngresado) {
                    alert("Por favor, ingresa tu n√∫mero registrado.");
                    $("#telefonoUsado").focus();
                    return;
                }
                if (!telefonosRegistrados.includes(telefonoIngresado)) {
                    alert("El n√∫mero ingresado no est√° registrado. Verifica e intenta nuevamente.");
                    $("#telefonoUsado").focus();
                    return;
                }
            }

            if (!this.checkValidity()) {
                this.reportValidity();
                return;
            }

            $("#spinner").fadeIn(200);

            try {
                const formData = new FormData(this);
                const response = await fetch(scriptURL, {
                    method: "POST",
                    body: formData,
                });

                if (response.ok) {
                    alert("Datos enviados correctamente");
                    $("#formulario")[0].reset();
                    $(".select2").val(null).trigger("change");

                    $("#camposDelivery, #camposShalom, #camposUsados")
                        .hide()
                        .find("input, select")
                        .prop("disabled", true);

                    $("#contenedorFecha").hide();
                    $("#fecha").empty();
                    const nuevasFechas = obtenerFechasEnvio();
                    nuevasFechas.forEach(f => {
                        $("#fecha").append(
                            $("<option>").val(f.toISOString().split("T")[0]).text(formatearFecha(f))
                        );
                    });
                } else {
                    alert("Ocurri√≥ un error al enviar tus datos.");
                }
            } catch (error) {
                alert("Ocurri√≥ un error de red o en el servidor.");
                console.error("Error:", error);
            } finally {
                $("#spinner").fadeOut(200);
            }
        }
        
        // Funci√≥n principal de inicializaci√≥n
        $(document).ready(function () {
            // Cargar datos al inicio
            Promise.all([
                $.getJSON("https://raw.githubusercontent.com/complicidad/form/main/lstDistritos.json"),
                $.getJSON("https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json"),
                $.getJSON(`${scriptURL}?sheet=Clientes`)
            ]).then(([distritosData, agenciasData, telefonosData]) => {
                distritos = distritosData.map(item => typeof item === "string" ? item : item.Distrito || item.nombre || "");
                agencias = agenciasData.map(item => typeof item === "string" ? item : item.Shalom || item.nombre || "");
                telefonosRegistrados = telefonosData.values.map(row => String(row[0]).replace(/\D/g, "")).filter(t => t.length === 9);

                // Carga las fechas en el select
                const $selectFecha = $("#fecha");
                const fechas = obtenerFechasEnvio();
                fechas.forEach((f) => {
                    const option = $("<option>").val(f.toISOString().split("T")[0]).text(formatearFecha(f));
                    $selectFecha.append(option);
                });

                // Inicializar los manejadores de eventos
                $("#tipoAccion").on("change", manejarCambioServicio);
                $("#formulario").on("submit", manejarEnvioFormulario);

            }).catch(err => {
                console.error("Error al cargar datos necesarios:", err);
                alert("Error al cargar datos necesarios para el formulario. Por favor, recarga la p√°gina.");
            });
        });
    </script>
</body>
</html>
