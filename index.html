<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario SAF - Cliente Final</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <style>

    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input { width: 100%; padding: 8px; margin-top: 5px; }
    .select2-container .select2-selection--single { height: 38px; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { white-space: pre-line; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .select2-container { width: 100% !important; }
    
  </style>
</head>
<body>

  <h2>Programar mi env√≠o</h2>

  <form id="formulario">
    <label>¬øQu√© deseas hacer?</label>
    <select id="tipoAccion" name="tipoAccion" required>
      <option value="" disabled selected>Selecciona una opci√≥n</option>
      <option value="delivery">üìù Quiero mi env√≠o por Delivery</option>
      <option value="shalom">üìù Quiero mi env√≠o por Shalom</option>
      <option value="usado">üì≤ Quiero usar mi direcci√≥n registrada</option>
    </select>
    
    <div id="camposDelivery" style="display: none;">
      <label>Nombre completo:</label>
      <input type="text" name="nombre" required>

      <label>Tel√©fono:</label>
      <input type="text" name="telefono" required>
      
      <label>Distrito:</label>
      <select id="distrito" name="distrito" required></select>
      
      <label>Direcci√≥n:</label>
      <input type="text" name="direccion" required>

      <label>Referencia:</label>
      <input type="text" name="referencia" required>
      
      <label>Fecha de env√≠o:</label>
      <input type="date" name="fecha" required>
    </div>

    <div id="camposShalom" style="display: none;">
      <label>Nombre completo:</label>
      <input type="text" name="nombre" required>

      <label>Tel√©fono:</label>
      <input type="text" name="telefono" required>
      
      <label>DNI:</label>
      <input type="text" name="DNI" required>

      <label>Agencia:</label>
      <select id="agencia" name="agencia" class="select2" required></select>

      <label>Fecha de env√≠o:</label>
      <input type="date" name="fecha" required>
    </div>

    <div id="camposUsados" style="display: none;">
      <label>Selecciona tu n√∫mero registrado:</label>
      <select id="telefonoUsado" name="telefonoUsado" class="select2" required></select>

      <label>Fecha de env√≠o:</label>
      <input type="date" name="fecha" required>
    </div>

    <button type="submit">Enviar</button>
  </form>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwywJN-AoE39NHrAwAYR0GFfrs94ys-1eIyEvn0SNLPPhUMBCK9hBWbYfP1CrZ6o20npQ/exec";

    $(document).ready(function () {
    
      // Deshabilitar todos los bloques
      $('#camposDelivery, #camposShalom, #camposUsados')
        .find('input, select')
        .prop('disabled', true);
      
      // 1. Inicializar Select2
      $('#distrito').select2({ placeholder: 'Selecciona un distrito', allowClear: true });
      // 2. Cargar opciones
      $.getJSON(`${scriptURL}?sheet=Distrito`)
        .done(data => {
          data.values.forEach(d => {
            $('#distrito').append(`<option value="${d[0]}">${d[0]}</option>`);
          });
          // 3. Refrescar el select2
          $('#distrito').trigger('change');
        });

      // Cargar agencias
      $.getJSON(scriptURL + "?sheet=Shalom", function (data) {
        data.values.forEach(function (a) {
          const texto = a[0];
          $('#agencia').append(new Option(texto, texto));
        });

        $('#agencia').select2({
          placeholder: 'Selecciona una agencia',
          allowClear: true,
          templateResult: function (data) {
            if (!data.id) return data.text;
            const lineas = data.text.split('\n');
            return $('<span>').html(`<strong>${lineas[0]}</strong><br>${lineas.slice(1).join('<br>')}`);
          },
          templateSelection: function (data) {
            return data.text.split('\n')[0];
          }
        });
      });

      // Cargar tel√©fonos registrados
      $.getJSON(scriptURL + "?sheet=Clientes", function (data) {
        data.values.forEach(function (row) {
          const telefono = row[0];
          if (/^\d{9}$/.test(telefono)) {
            $('#telefonoUsado').append(new Option(telefono, telefono));
          }
        });
        $('#telefonoUsado').select2({
          placeholder: 'Selecciona tu n√∫mero registrado',
          allowClear: true
        });
      });

      // Mostrar/ocultar campos seg√∫n acci√≥n
      $('#tipoAccion').on('change', function () {

        // üîπ Limpia todos los inputs y selects
        $('#formulario')[0].reset();
      
        // üîπ Limpia todos los select2
        $('.select2').val(null).trigger('change');
        
        // 1) Ocultar y deshabilitar todo
        $('#camposDelivery, #camposShalom, #camposUsados')
          .hide()
          .find('input, select')
          .prop('disabled', true);
      
        // 2) Mostrar y habilitar el bloque correspondiente
        const v = $(this).val();
        if (v === 'delivery') {
          $('#camposDelivery').show().find('input, select').prop('disabled', false);
        }
        else if (v === 'shalom') {
          $('#camposShalom').show().find('input, select').prop('disabled', false);
        }
        else if (v === 'usado') {
          $('#camposUsados').show().find('input, select').prop('disabled', false);
        }
      });

      // Env√≠o del formulario
      $('#formulario').on('submit', function (e) {
        e.preventDefault();
        const tipoAccion = $('#tipoAccion').val();
        const formData = new FormData(this);

        if (tipoAccion === 'usado' && !$('#telefonoUsado').val()) {
          alert('Selecciona un n√∫mero registrado.');
          return;
        }

        $.ajax({
          url: scriptURL,
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function () {
            alert("Datos enviados correctamente");
            $('#formulario')[0].reset();
            $('.select2').val(null).trigger('change');
            $('#camposDelivery, #camposShalom, #camposUsados')
              .hide()
              .find('input, select')
              .prop('disabled', true);
          },
          error: function () {
            alert("Ocurri√≥ un error al enviar tus datos");
          }
        });
      });
    });
  </script>

</body>
</html>
