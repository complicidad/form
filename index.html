<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda tu env√≠o</title>

    <meta property="og:title" content="Agenda tu env√≠o" />
    <meta property="og:description" content="Agenda tu env√≠o de manera simple, r√°pida y segura." />
    <meta property="og:image" content="https://complicidad.github.io/form/Spin.png" />
    <meta property="og:url" content="https://complicidad.github.io/form" />
    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Agenda tu env√≠o" />
    <meta name="twitter:description" content="Agenda tu env√≠o de manera simple, r√°pida y segura." />
    <meta name="twitter:image" content="https://complicidad.github.io/form/Spin.png" />
      
  

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Estilos del sitio -->
  <style>
       
    /* =========================================
       Tokens y base// Ejemplo: setBrandColor("#e11d48"); // rosa fuerte
    ========================================== */
    :root {
      --brand: #1a73e8;
      --brand-hover: #1669c1;
      --text: #222;
      --muted: #555;
      --bg-muted: #f4f4f4;
      --border: #e5e5e5;
      --danger: #d93025;
      --radius: 12px;
      --space-1: 5px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 15px;
      --space-5: 20px;
    }
    
    /* =========================================
       Estilos combinados para la estructura y el contenedor
    ========================================== */
    body {
        display: flex;
        flex-direction: column;
        min-height: 93vh;
        margin: 0;
        background: #0;
    }

    main.container {
        flex: 1; /* Permite que crezca para empujar el footer */
        padding: var(--space-5);
        max-width: 900px; /* Aqu√≠ puedes ajustar el ancho que desees */
        margin: 0 auto;
        font-family: 'Nunito', sans-serif;
        color: var(--text);
    }

    /* Secciones de formulario */
    .section {
      margin-top: var(--space-4);
    }

    .section-help {
      margin: var(--space-2) 0;
      color: var(--muted);
      font-size: 13px;
    }

    /* Accesibilidad: oculto visualmente pero accesible */
    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap;
    }

    /* Etiquetas y controles */
    label {
      display: block;
      margin-top: var(--space-4);
      font-weight: bold;
    }

    input, select, button {
      font: inherit;
    }

    input, select {
      width: 100%;
      padding: var(--space-2);
      margin-top: var(--space-1);
      box-sizing: border-box;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: #fff;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }

    input:focus, select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
    }

    /* Estado de error b√°sico para validaci√≥n */
    .is-invalid {
      border-color: var(--danger) !important;
      box-shadow: 0 0 0 3px rgba(217, 48, 37, .15) !important;
    }

    /* Texto de privacidad */
    .texto-privacidad {
      margin-top: var(--space-2);
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }

    .texto-privacidad a {
      color: var(--brand);
      text-decoration: none;
    }

    /* Botones */
    .contenedor-boton {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-top: var(--space-4);
    }

    button[type="submit"] {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: var(--brand);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      width: 100%;
      transition: background-color .15s ease;
    }

    button[type="submit"]:hover {
      background-color: var(--brand-hover);
    }
    

    /* =========================================
       Spinner de carga
       
    ========================================== */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #spinner {
      display: none;
      position: fixed;
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #spinner img {
      width: 100px; 
      height: auto; 
      animation: spin 1s linear infinite;
    }
 
     /* Estilo del overlay del popup */
    .modal {
      display: none; /* Oculto por defecto */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      justify-content: center;
      align-items: center;
      align-items: flex-start; /* Alinea arriba en vez de al centro */
      padding-top: 20px; /* Espacio desde arriba */
      padding-bottom: 20px; /* Espacio desde arriba */
    }

    /* Caja del popup */
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 350px;
      max-height: 95vh; /* Antes 80vh, ahora m√°s alto */
      overflow-y: auto;
    }
    
    .list {
      max-height: 80vh;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin: 0;
    }
 
    .list-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .list-item:hover {
      background: #f0f0f0;
    }    
    
    /* Compatibilidad con IDs existentes */
    #listaDistritos, #listaAgencias {
      max-height: 80vh;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #listaDistritos li, #listaAgencias li {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    #listaDistritos li:hover, #listaAgencias li:hover {
      background: #f0f0f0;
    }
     
    .hint{font-size:12px;color:var(--muted);margin-bottom:8px; opacity:.5}

    .mensaje {
      display: none;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      font-weight: 500;
      font-family: 'Nunito', sans-serif;
    }
    .mensaje.success { background: #dcfce7; color: #166534; }
    .mensaje.error   { background: #fee2e2; color: #b91c1c; }

  </style>
</head>
<body>
  
  <div id="mensaje" class="mensaje"></div>
  
  <div style="text-align:center; margin: 15px;">
  <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Logo Complicidad" style="max-width: 100px; height: auto;">
  </div>

  <main class="container">  
  
  <h2 style="margin: -30px 0px 5px; text-align:center; ">Agenda tu env√≠o</h2>
  
  <form id="formulario" novalidate>
    <label for="telefonoUsado">WhatsApp con el que compraste</label>
    <input
      type="text"
      id="telefonoUsado"
      name="telefonoUsado"
      required
      placeholder="Ingresa tu n√∫mero"
      pattern="\d{9}"
      title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
    />

    <label for="tipoAccion">Selecciona el tipo de servicio</label>
    <select id="tipoAccion" name="tipoAccion" required>
      <option value="" disabled selected>Elige una opci√≥n</option>
      <option value="delivery">Env√≠o a domicilio/trabajo (Delivery)</option>
      <option value="shalom">Retiro en agencia Shalom</option>
      <option value="recoger">Recoger en almac√©n</option>
      <option value="usado">Usar mi direcci√≥n registrada</option>
    </select>

    <!-- Delivery -->
    <fieldset id="camposDelivery" class="section section--delivery" hidden>
       <legend>üì¶ Delivery</legend>
       <p class="section-help">Datos de la persona que recibir√° el pedido.</p>

      <label for="nombreDelivery">Nombre:</label>
      <input type="text" id="nombreDelivery" name="nombre" required />

      <label for="telefonoDelivery">Tel√©fono:</label>
      <input
        type="text"
        id="telefonoDelivery"
        name="telefono"
        required
        pattern="\d{9}"
        title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
      />

      <label for="distrito">Distrito:</label>
      <input type="text" id="distrito" name="distrito" required />

      <label for="direccion">Direcci√≥n:</label>
      <input type="text" id="direccion" name="direccion" required />

      <label for="referencia">Referencia:</label>
      <input type="text" id="referencia" name="referencia" required />
      
            <!-- Modal oculto -->
      <div class="modal" id="modalDistrito">
        <div class="modal-content">
          <input type="text" id="buscadorDistrito" placeholder="Buscar distrito...">
          <div id="listaDistritos"></div>
        </div>
      </div>
     </fieldset>
    
     <!-- Shalom -->
     <fieldset id="camposShalom" class="section section--shalom" hidden>
       <legend>üì¶ Shalom</legend>
       <p class="section-help">Datos para retiro en agencia Shalom.</p>

      <label for="nombreShalom">Nombre completo:</label>
      <input type="text" id="nombreShalom" name="nombre" required />

      <label for="telefonoShalom">Tel√©fono:</label>
      <input
        type="text"
        id="telefonoShalom"
        name="telefono"
        required
        pattern="\d{9}"
        title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
      />

      <label for="DNI">DNI/CE:</label>
      <input type="text" id="DNI" name="DNI" required />

      <label for="agencia">Agencia:</label>
      <input type="text" id="agencia" name="agencia" required />
      
            <!-- Modal oculto -->
      <div class="modal" id="modalAgencia">
        <div class="modal-content">
          <input type="text" id="buscadorAgencia" placeholder="Buscar agencia...">
          <div id="listaAgencias"></div>
        </div>
      </div>          
    </fieldset>
   
    <!-- Usado -->
    <fieldset id="camposUsados" class="section section--usado" hidden>
      <legend>üì¶ Direcci√≥n registrada</legend>
      <p class="section-help">Usaremos tu direcci√≥n guardada.</p>
    </fieldset>

    <!-- Campo de fecha reutilizable -->
    <div id="contenedorFecha" style="display: none;">
      <label for="fecha">Fecha de env√≠o:</label>
      <select id="fecha" name="fecha" required></select>
    </div>

    <div class="contenedor-boton">
      <button type="submit">Confirmar y agendar env√≠o</button>
    </div>   
    

    
    
     <div class="texto-privacidad">
      Usaremos tus datos solo para procesar y entregar tu pedido.
      <a href="https://complicidad.github.io/privacy/" target="_blank">Ver pol√≠tica de privacidad</a>
    </div>   
    
          <div style="margin: 10px 0; display: flex; justify-content: center; gap: 16px;">
    <a href="https://wa.me/51981391159" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center;">
      <img src="https://raw.githubusercontent.com/complicidad/form/main/whatsapp.png" alt="WhatsApp" width="28" height="28">
    </a>

    <a href="https://www.tiktok.com/@complicidadboutique" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center;">
      <img src="https://raw.githubusercontent.com/complicidad/form/main/tik-tok.png" alt="TikTok" width="28" height="28">
    </a>

    <a href="https://www.instagram.com/complicidadboutique" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center;">
      <img src="https://raw.githubusercontent.com/complicidad/form/main/instagram.png" alt="Instagram" width="28" height="28">
    </a>
  </div>  
    
    
  </form>
  </main>
  
  
<footer style="
  background-color:#0; 
  padding:1px 1px;
  text-align: center;
  font-family: sans-serif;
  margin-top: 5px;
               
">
 
  <div class="hint">Creado por <strong>Gesti√≥nalo</strong></div>
  
</footer>


    <div id="spinner" style="
        display:none;
        position:fixed;
        top:0; left:0; 
        width:100%; height:100%;
        background:rgba(255,255,255,0.85);
        z-index:9999;
        justify-content:center;
        align-items:center;
        flex-direction:column;
    ">
        <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Cargando..." style="width:150px; height:auto; animation:spin 2s linear infinite;">
        <p style="margin-top:15px; font-size:18px; color:#333;"></p>
    </div>
  
  <script>
    
// Conf para Distritos    
const campoDistrito = document.getElementById("distrito");
const overlay = document.getElementById("modalDistrito");
const buscador = document.getElementById("buscadorDistrito");
const listaDistritos = document.getElementById("listaDistritos");
let distritos = [];

// Abrir popup al hacer click en el campo
campoDistrito.addEventListener("click", () => {
  overlay.style.display = "flex";
  buscador.value = "";
  mostrarDistritos(distritos);
  buscador.focus();
});

// Cerrar popup si clic fuera de la caja
overlay.addEventListener("click", (e) => {
  if (e.target === overlay) {
    overlay.style.display = "none";
  }
});

// Buscar distritos
buscador.addEventListener("input", () => {
  const filtro = buscador.value.toLowerCase();
  const filtrados = distritos.filter(d => d.toLowerCase().includes(filtro));
  mostrarDistritos(filtrados);
});

// Mostrar lista en el popup
function mostrarDistritos(lista) {
  listaDistritos.innerHTML = "";
  lista.forEach(d => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.textContent = d;
    div.addEventListener("click", () => {
      campoDistrito.value = d;
      overlay.style.display = "none";
    });
    listaDistritos.appendChild(div);
  });
}

// Cargar JSON de distritos
fetch("https://raw.githubusercontent.com/complicidad/form/main/lstDistritos.json")
  .then(res => res.json())
  .then(data => {
    // El JSON puede ser un array de strings o de objetos
    distritos = data.map(item => typeof item === "string" ? item : item.Distrito || item.nombre || "");
    mostrarDistritos(distritos);
  })
  .catch(err => {
    console.error("Error cargando distritos:", err);
  });
 
// Conf para Agencias
const campoAgencia = document.getElementById("agencia");
const overlayAgencia = document.getElementById("modalAgencia");
const buscadorAgencia = document.getElementById("buscadorAgencia");
const listaAgencias = document.getElementById("listaAgencias");
let agencias = [];

// Abrir popup al hacer click en el campo
campoAgencia.addEventListener("click", () => {
  overlayAgencia.style.display = "flex";
  buscadorAgencia.value = "";
  mostrarAgencias(agencias);
  buscadorAgencia.focus();
});

// Cerrar popup si clic fuera de la caja
overlayAgencia.addEventListener("click", (e) => {
  if (e.target === overlayAgencia) {
    overlayAgencia.style.display = "none";
  }
});

// Buscar agencias
buscadorAgencia.addEventListener("input", () => {
  const filtro = buscadorAgencia.value.toLowerCase();
  const filtrados = agencias.filter(a => a.toLowerCase().includes(filtro));
  mostrarAgencias(filtrados);
});

// Mostrar lista en el popup
function mostrarAgencias(lista) {
  listaAgencias.innerHTML = "";
  lista.forEach(a => {
    const [titulo, ...resto] = a.split("\n"); // Separar en partes
    const div = document.createElement("div");
    div.className = "list-item";
    // Armamos el HTML con la primera l√≠nea en negrita
    div.innerHTML = `<strong>${titulo}</strong>${resto.length ? "<br>" + resto.join("<br>") : ""}`;
    div.addEventListener("click", () => {
      campoAgencia.value = titulo; // Mantener el valor original con \n
      overlayAgencia.style.display = "none";
    });
    listaAgencias.appendChild(div);
  });
}

// Cargar JSON de agencias
fetch("https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json")
  .then(res => res.json())
  .then(data => {
    // El JSON puede ser un array de strings o de objetos
    agencias = data.map(item => typeof item === "string" ? item : item.Shalom || item.nombre || "");
    mostrarAgencias(agencias);
  })
  .catch(err => {
    console.error("Error cargando agencias:", err);
  });

     
    
    $(document).ready(function () {

      const scriptURL =
        "https://script.google.com/macros/s/AKfycbzSqYVbDXoRSCvuUl-l-jAtiLauLj-h5KT99WJFxZQ4IBu1M_ErSj3foXqlrEoS3INuCA/exec";

      let telefonosRegistrados = [];

      /**
       * Obtiene las fechas v√°lidas para env√≠o: martes y viernes,
       * hasta dos semanas adelante y con horario de corte a las 10:00 a.m. del d√≠a anterior.
       * @returns {Date[]} Array de fechas v√°lidas
       */
      function obtenerFechasEnvio() {
        const ahora = new Date();
        const opciones = [];
        const diasPermitidos = [2, 5]; // martes = 2, viernes = 5
        const horaCorte = 10; // 10:00 a.m.
        const limite = new Date();
        limite.setDate(ahora.getDate() + 14); // hasta 2 semanas adelante

        let fecha = new Date();
        fecha.setHours(0, 0, 0, 0); // normaliza la hora

        while (fecha <= limite) {
          const diaSemana = fecha.getDay();

          if (diasPermitidos.includes(diaSemana)) {
            // D√≠a v√°lido, chequeamos horario de corte (10 a.m. d√≠a anterior)
            const fechaCorte = new Date(fecha);
            fechaCorte.setDate(fecha.getDate() - 1);
            fechaCorte.setHours(horaCorte, 0, 0, 0);

            if (ahora < fechaCorte) {
              opciones.push(new Date(fecha));
            }
          }
          fecha.setDate(fecha.getDate() + 1);
        }
        return opciones;
      }

      /**
       * Formatea una fecha a string en espa√±ol, con d√≠a de semana, d√≠a, mes y a√±o.
       * Ejemplo: "martes, 15 de agosto de 2025"
       * @param {Date} fecha
       * @returns {string}
       */
      function formatearFecha(fecha) {
        return fecha.toLocaleDateString("es-ES", {
          weekday: "long",
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
      }

      // Carga las fechas en el select #fecha
      const $selectFecha = $("#fecha");
      const fechas = obtenerFechasEnvio();
      fechas.forEach((f) => {
        const option = $("<option>")
          .val(f.toISOString().split("T")[0])
          .text(formatearFecha(f));
        $selectFecha.append(option);
      });

      // Cargar tel√©fonos registrados desde Google Sheets
      const cargarTelefonos = $.getJSON(`${scriptURL}?sheet=Clientes`)
        .done((data) => {
          // Extrae y normaliza tel√©fonos de 9 d√≠gitos
          telefonosRegistrados = data.values
            .map((row) => String(row[0]).replace(/\D/g, ""))
            .filter((t) => t.length === 9);
        })
        .fail(() => {
          alert("No se pudieron cargar los tel√©fonos registrados.");
        });

      // Espera a que todo se cargue antes de continuar
      Promise.all([cargarTelefonos]).catch(() =>
        alert("Error al cargar datos necesarios para el formulario.")
      );

      /**
       * Limpia inputs y selects dentro de un contenedor por ID
       * @param {string} idContenedor
       */
      function limpiarCampos(idContenedor) {
        const selector = `#${idContenedor} input, #${idContenedor} select`;
        document.querySelectorAll(selector).forEach((campo) => {
          if (campo.tagName === "SELECT") {
            $(campo).val(null).trigger("change");
          } else {
            campo.value = "";
          }
        });
      }

      // Muestra/oculta bloques de campos seg√∫n la opci√≥n seleccionada
      $("#tipoAccion").on("change", function () {
        limpiarCampos("camposDelivery");
        limpiarCampos("camposShalom");
        limpiarCampos("camposUsados");

        // Oculta todos los bloques y deshabilita inputs/selects dentro
        $("#camposDelivery, #camposShalom, #camposUsados")
          .hide()
          .find("input, select")
          .prop("disabled", true);

        const valor = $(this).val();

        // Mostrar y habilitar bloque correspondiente
        if (valor === "delivery") {
          $("#camposDelivery").show().find("input, select").prop("disabled", false);
        } else if (valor === "shalom") {
          $("#camposShalom").show().find("input, select").prop("disabled", false);
        } else if (valor === "usado") {
          $("#camposUsados").show().find("input, select").prop("disabled", false);
        }

        // Mover y mostrar campo fecha en el bloque correspondiente
        const $contenedorFecha = $("#contenedorFecha");
        $contenedorFecha.hide();

        if (["delivery", "shalom", "usado"].includes(valor)) {
          if (valor === "delivery") {
            $("#camposDelivery").append($contenedorFecha);
          } else if (valor === "shalom") {
            $("#camposShalom").append($contenedorFecha);
          } else {
            $("#camposUsados").append($contenedorFecha);
          }
          $contenedorFecha.show();
          $("#fecha").prop("disabled", false);
        } else {
          $("#fecha").prop("disabled", true);
        }
      });

      // Env√≠o del formulario con validaci√≥n extra para opci√≥n "usado"
      $("#formulario").on("submit", function (e) {
        e.preventDefault();
        
      function mostrarMensajeTelefono(mensaje, tipo="success") {
        $("#mensaje")
          .removeClass()
          .addClass("mensaje " + tipo)
          .text(mensaje)
          .slideDown();
      }  
        
        const tipoAccion = $("#tipoAccion").val();

        // Validaci√≥n personalizada para "usado"
        if (tipoAccion === "usado") {
          const telefonoIngresado = $("#telefonoUsado")
            .val()
            .replace(/\D/g, "");

          if (!telefonoIngresado) {
            mostrarMensajeTelefono("Por favor, ingresa tu n√∫mero registrado", "error");
            $("#telefonoUsado").focus();
            return;
          }

          if (!telefonosRegistrados.includes(telefonoIngresado)) {
            mostrarMensajeTelefono("‚ùå El n√∫mero ingresado no est√° registrado. Verifica e intenta nuevamente", "error");
            $("#telefonoUsado").focus();
            return;
          }
        }

        // Validaci√≥n nativa HTML5 para campos visibles
        if (!this.checkValidity()) {
          // Esto activar√° mensajes nativos del navegador
          this.reportValidity();
          return;
        }

        // Mostrar spinner antes de enviar
        $("#spinner").fadeIn(200);
     
        // Prepara FormData para enviar
        const formData = new FormData(this);
        
        function mostrarMensaje(mensaje, tipo="success") {
          $("#mensaje")
            .removeClass()
            .addClass("mensaje " + tipo)
            .text(mensaje)
            .slideDown();
        }   
                
        // Env√≠o AJAX
        $.ajax({
          url: scriptURL,
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: () => {
            mostrarMensaje("‚úÖ Datos enviados correctamente", "success");
            // Resetea formulario y Select2
            $("#formulario")[0].reset();
            $(".select2").val(null).trigger("change");

            // Oculta todos los bloques y deshabilita inputs
            $("#camposDelivery, #camposShalom, #camposUsados")
              .hide()
              .find("input, select")
              .prop("disabled", true);

            // Oculta y limpia campo fecha
            $("#contenedorFecha").hide();
            $("#fecha").empty();
            const nuevasFechas = obtenerFechasEnvio();
            nuevasFechas.forEach(f => {
              $("#fecha").append(
                $("<option>").val(f.toISOString().split("T")[0]).text(formatearFecha(f))
              );
            });
          },
          error: () => {
            mostrarMensaje("‚ùå Ocurri√≥ un error al enviar tus datos", "error");
          },
          complete: () => {
            // Ocultar spinner siempre al finalizar
            $("#spinner").fadeOut(200);
          }
        });
      });
    });
  </script>
    
</body>
</html>
