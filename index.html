<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda tu env√≠o</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Select2 CSS & JS -->
  <link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    select,
    input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
      border-radius: 8px;
    }

    .select2-container {
      width: 100% !important;
    }

    .select2-container .select2-selection--single {
      height: 38px;
    }

    .select2-container--default .select2-selection--single
      .select2-selection__rendered {
      white-space: pre-line;
    }

    .contenedor-boton {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    button[type="submit"] {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #spinner {
      display: none;
      position: fixed;
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #spinner img {
      width: 100px; 
      height: auto; 
      animation: spin 1s linear infinite;
    }
    
  </style>
</head>
<body>

  <div style="text-align:center; margin-bottom: 0px;">
  <img src="https://raw.githubusercontent.com/complicidad/form/main/Logo.png" alt="Logo Complicidad" style="max-width: 200px; height: auto;">
  </div>

  <h2>Agenda tu env√≠o</h2>
  
  <form id="formulario" novalidate>
    <label for="telefonoUsado">WhatsApp con el que compraste</label>
    <input
      type="text"
      id="telefonoUsado"
      name="telefonoUsado"
      required
      placeholder="Ingresa tu n√∫mero"
      pattern="\d{9}"
      title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
    />

    <label for="tipoAccion">Selecciona el tipo de servicio</label>
    <select id="tipoAccion" name="tipoAccion" required>
      <option value="" disabled selected>Elige una opci√≥n</option>
      <option value="delivery">Env√≠o a domicilio/trabajo (Delivery)</option>
      <option value="shalom">Retiro en agencia Shalom</option>
      <option value="recoger">Recoger en almac√©n</option>
      <option value="usado">Usar mi direcci√≥n registrada</option>
    </select>

    <div id="camposDelivery" style="display: none;">
      <h2>üì¶ Delivery</h2>
      <legend>Datos de la persona que recibir√° el pedido en su domicilio o trabajo</legend>

      <label for="nombreDelivery">Nombre:</label>
      <input type="text" id="nombreDelivery" name="nombre" required />

      <label for="telefonoDelivery">Tel√©fono:</label>
      <input
        type="text"
        id="telefonoDelivery"
        name="telefono"
        required
        pattern="\d{9}"
        title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
      />

      <label for="distrito">Distrito:</label>
      <select id="distrito" name="distrito" required></select>

      <label for="direccion">Direcci√≥n:</label>
      <input type="text" id="direccion" name="direccion" required />

      <label for="referencia">Referencia:</label>
      <input type="text" id="referencia" name="referencia" required />
    </div>

    <div id="camposShalom" style="display: none;">
      <h2>üì¶ Shalom</h2>
      <legend>Datos de la persona que recoger√° el pedido en la agencia Shalom</legend>

      <label for="nombreShalom">Nombre completo:</label>
      <input type="text" id="nombreShalom" name="nombre" required />

      <label for="telefonoShalom">Tel√©fono:</label>
      <input
        type="text"
        id="telefonoShalom"
        name="telefono"
        required
        pattern="\d{9}"
        title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
      />

      <label for="DNI">DNI/CE:</label>
      <input type="text" id="DNI" name="DNI" required />

      <label for="agencia">Agencia:</label>
      <select id="agencia" name="agencia" class="select2" required></select>
    </div>

    <div id="camposUsados" style="display: none;">
      <h2>üòç Ya eres parte de la familia</h2>
      <legend>Solo elige tu fecha de env√≠o:</legend>
    </div>

    <!-- Campo de fecha reutilizable -->
    <div id="contenedorFecha" style="display: none;">
      <label for="fecha">Fecha de env√≠o:</label>
      <select id="fecha" name="fecha" required></select>
    </div>

    <div class="contenedor-boton">
      <button type="submit">Enviar</button>
    </div>
  </form>

  <footer
    style="
      padding: 20px;
      text-align: center;
      font-family: sans-serif;
      margin-top: 40px;
    "
  >
    <div style="margin-top: 10px;">
      <a
        href="https://www.tiktok.com/@complicidadboutique"
        target="_blank"
        rel="noopener noreferrer"
        style="margin-right: 15px; text-decoration: none"
        ><img
          src="https://cdn-icons-png.flaticon.com/512/3046/3046122.png"
          alt="TikTok"
          width="24"
          style="vertical-align: middle"
      /><span
        style="margin-left: 5px; font-size: 14px"
        ></span
      ></a>

      <a
        href="https://wa.me/51981391159"
        target="_blank"
        rel="noopener noreferrer"
        style="text-decoration: none"
        ><img
          src="https://cdn-icons-png.flaticon.com/512/733/733585.png"
          alt="WhatsApp"
          width="24"
          style="vertical-align: middle"
      /><span style="margin-left: 5px; font-size: 14px"></span></a>
    </div>

    <p style="margin-top: 15px; font-size: 12px; color: #888">
      ¬© 2025 Complicidad. Todos los derechos reservados.
    </p>
  </footer>

    <div id="spinner" style="
        display:none;
        position:fixed;
        top:0; left:0; 
        width:100%; height:100%;
        background:rgba(255,255,255,0.85);
        z-index:9999;
        justify-content:center;
        align-items:center;
        flex-direction:column;
    ">
        <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Cargando..." style="width:150px; height:auto; animation:spin 2s linear infinite;">
        <p style="margin-top:15px; font-size:18px; color:#333;"></p>
    </div>
  
  <script>
    $(document).ready(function () {
      const urlDistritos =
        "https://raw.githubusercontent.com/complicidad/form/main/lstDistritos.json";
      const urlShalom =
        "https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json";
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbwo9LnbOnd6880OJK67SeW-BUbJf4oDMKPilBH-S2o2mzfk6W6KXPkkwy3Z-l_PVW4VQg/exec";

      let telefonosRegistrados = [];

      /**
       * Obtiene las fechas v√°lidas para env√≠o: martes y viernes,
       * hasta dos semanas adelante y con horario de corte a las 10:00 a.m. del d√≠a anterior.
       * @returns {Date[]} Array de fechas v√°lidas
       */
      function obtenerFechasEnvio() {
        const ahora = new Date();
        const opciones = [];
        const diasPermitidos = [2, 5]; // martes = 2, viernes = 5
        const horaCorte = 10; // 10:00 a.m.
        const limite = new Date();
        limite.setDate(ahora.getDate() + 14); // hasta 2 semanas adelante

        let fecha = new Date();
        fecha.setHours(0, 0, 0, 0); // normaliza la hora

        while (fecha <= limite) {
          const diaSemana = fecha.getDay();

          if (diasPermitidos.includes(diaSemana)) {
            // D√≠a v√°lido, chequeamos horario de corte (10 a.m. d√≠a anterior)
            const fechaCorte = new Date(fecha);
            fechaCorte.setDate(fecha.getDate() - 1);
            fechaCorte.setHours(horaCorte, 0, 0, 0);

            if (ahora < fechaCorte) {
              opciones.push(new Date(fecha));
            }
          }
          fecha.setDate(fecha.getDate() + 1);
        }
        return opciones;
      }

      /**
       * Formatea una fecha a string en espa√±ol, con d√≠a de semana, d√≠a, mes y a√±o.
       * Ejemplo: "martes, 15 de agosto de 2025"
       * @param {Date} fecha
       * @returns {string}
       */
      function formatearFecha(fecha) {
        return fecha.toLocaleDateString("es-ES", {
          weekday: "long",
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
      }

      // Carga las fechas en el select #fecha
      const $selectFecha = $("#fecha");
      const fechas = obtenerFechasEnvio();
      fechas.forEach((f) => {
        const option = $("<option>")
          .val(f.toISOString().split("T")[0])
          .text(formatearFecha(f));
        $selectFecha.append(option);
      });

      // Inicializar Select2 en distritos y agencias
      $("#distrito").select2({
        placeholder: "Escribe el distrito...",
        dropdownAutoWidth: false,
        width: "100%",
      });

      $("#agencia").select2({
        placeholder: "Selecciona una agencia",
        dropdownAutoWidth: false,
        width: "100%",
        templateResult: function (data) {
          if (!data.id) return data.text;
          const lineas = data.text.split("\n");
          return $("<span>").html(
            `<strong>${lineas[0]}</strong><br>${lineas.slice(1).join("<br>")}`
          );
        },
        templateSelection: function (data) {
          return data.text ? data.text.split("\n")[0] : "";
        },
      });

      // Cargar distritos desde JSON remoto
      const cargarDistritos = $.getJSON(urlDistritos)
        .done((data) => {
          let opciones = '<option value=""></option>';
          data.forEach((d) => {
            opciones += `<option value="${d.Distrito}">${d.Distrito}</option>`;
          });
          $("#distrito").html(opciones).trigger("change");
        })
        .fail(() => {
          alert("No se pudieron cargar los distritos.");
        });

      // Cargar agencias desde JSON remoto
      const cargarAgencias = $.getJSON(urlShalom)
        .done((data) => {
          let opciones = '<option value=""></option>';
          data.forEach((d) => {
            opciones += `<option value="${d.Shalom}">${d.Shalom}</option>`;
          });
          $("#agencia").html(opciones).trigger("change");
        })
        .fail(() => {
          alert("No se pudieron cargar las agencias.");
        });

      // Cargar tel√©fonos registrados desde Google Sheets
      const cargarTelefonos = $.getJSON(`${scriptURL}?sheet=Clientes`)
        .done((data) => {
          // Extrae y normaliza tel√©fonos de 9 d√≠gitos
          telefonosRegistrados = data.values
            .map((row) => String(row[0]).replace(/\D/g, ""))
            .filter((t) => t.length === 9);
        })
        .fail(() => {
          alert("No se pudieron cargar los tel√©fonos registrados.");
        });

      // Espera a que todo se cargue antes de continuar
      Promise.all([cargarDistritos, cargarAgencias, cargarTelefonos]).catch(() =>
        alert("Error al cargar datos necesarios para el formulario.")
      );

      /**
       * Limpia inputs y selects dentro de un contenedor por ID
       * @param {string} idContenedor
       */
      function limpiarCampos(idContenedor) {
        const selector = `#${idContenedor} input, #${idContenedor} select`;
        document.querySelectorAll(selector).forEach((campo) => {
          if (campo.tagName === "SELECT") {
            $(campo).val(null).trigger("change");
          } else {
            campo.value = "";
          }
        });
      }

      // Muestra/oculta bloques de campos seg√∫n la opci√≥n seleccionada
      $("#tipoAccion").on("change", function () {
        limpiarCampos("camposDelivery");
        limpiarCampos("camposShalom");
        limpiarCampos("camposUsados");

        // Oculta todos los bloques y deshabilita inputs/selects dentro
        $("#camposDelivery, #camposShalom, #camposUsados")
          .hide()
          .find("input, select")
          .prop("disabled", true);

        const valor = $(this).val();

        // Mostrar y habilitar bloque correspondiente
        if (valor === "delivery") {
          $("#camposDelivery").show().find("input, select").prop("disabled", false);
        } else if (valor === "shalom") {
          $("#camposShalom").show().find("input, select").prop("disabled", false);
        } else if (valor === "usado") {
          $("#camposUsados").show().find("input, select").prop("disabled", false);
        }

        // Mover y mostrar campo fecha en el bloque correspondiente
        const $contenedorFecha = $("#contenedorFecha");
        $contenedorFecha.hide();

        if (["delivery", "shalom", "usado"].includes(valor)) {
          if (valor === "delivery") {
            $("#camposDelivery").append($contenedorFecha);
          } else if (valor === "shalom") {
            $("#camposShalom").append($contenedorFecha);
          } else {
            $("#camposUsados").append($contenedorFecha);
          }
          $contenedorFecha.show();
          $("#fecha").prop("disabled", false);
        } else {
          $("#fecha").prop("disabled", true);
        }
      });

      // Env√≠o del formulario con validaci√≥n extra para opci√≥n "usado"
      $("#formulario").on("submit", function (e) {
        e.preventDefault();
        

        
        const tipoAccion = $("#tipoAccion").val();

        // Validaci√≥n personalizada para "usado"
        if (tipoAccion === "usado") {
          const telefonoIngresado = $("#telefonoUsado")
            .val()
            .replace(/\D/g, "");

          if (!telefonoIngresado) {
            alert("Por favor, ingresa tu n√∫mero registrado.");
            $("#telefonoUsado").focus();
            return;
          }

          if (!telefonosRegistrados.includes(telefonoIngresado)) {
            alert(
              "El n√∫mero ingresado no est√° registrado. Verifica e intenta nuevamente."
            );
            $("#telefonoUsado").focus();
            return;
          }
        }

        // Validaci√≥n nativa HTML5 para campos visibles
        if (!this.checkValidity()) {
          // Esto activar√° mensajes nativos del navegador
          this.reportValidity();
          return;
        }

        // Mostrar spinner antes de enviar
        $("#spinner").fadeIn(200);
     
        // Prepara FormData para enviar
        const formData = new FormData(this);

        // Env√≠o AJAX
        $.ajax({
          url: scriptURL,
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: () => {
            alert("Datos enviados correctamente");
            // Resetea formulario y Select2
            $("#formulario")[0].reset();
            $(".select2").val(null).trigger("change");

            // Oculta todos los bloques y deshabilita inputs
            $("#camposDelivery, #camposShalom, #camposUsados")
              .hide()
              .find("input, select")
              .prop("disabled", true);

            // Oculta y limpia campo fecha
            $("#contenedorFecha").hide();
            $("#fecha").empty();
            const nuevasFechas = obtenerFechasEnvio();
            nuevasFechas.forEach(f => {
              $("#fecha").append(
                $("<option>").val(f.toISOString().split("T")[0]).text(formatearFecha(f))
              );
            });
          },
          error: () => {
            alert("Ocurri√≥ un error al enviar tus datos");
          },
          complete: () => {
            // Ocultar spinner siempre al finalizar
            $("#spinner").fadeOut(200);
          }
        });
      });
    });
  </script>
    
</body>
</html>
